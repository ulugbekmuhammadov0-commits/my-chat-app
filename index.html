<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ—Å—Ç–æ–π –ß–∞—Ç</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }
        #form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; display: flex; }
        #input { border: none; padding: 10px; width: 90%; margin-right: .5%; }
        #form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
        #messages { list-style-type: none; margin: 0; padding: 10px 0 60px 0; }
        
        #messages li {
            padding: 8px 12px;
            margin-bottom: 8px;
            max-width: 70%; 
            border-radius: 15px;
            word-wrap: break-word;
            clear: both; 
        }
        
        #messages li:not(.my-message) { 
            background: #eee;
            color: #000;
            float: left;
        }

        #messages li.my-message {
            background: #DCF8C6; 
            color: #000;
            float: right; 
        }
        
        #messages li em {
            display: block;
            text-align: center;
            width: 100%;
            margin: 0;
            padding: 0;
            float: none;
            background: none;
            font-size: 11px;
            color: #777;
        }

        /* –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        #nickname-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 10;
            padding: 20px;
        }
        #nickname-area input, #nickname-area button {
            padding: 15px;
            font-size: 18px;
            margin-top: 10px;
            width: 300px;
        }
        /* –°–∫—Ä—ã—Ç—å —á–∞—Ç, –ø–æ–∫–∞ –∏–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ */
        #messages, #form {
            display: none;
        }
    </style>
</head>
<body>
    <div id="nickname-area">
        <input id="nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" />
        <input id="password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" /> 
        <button id="set-nickname">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>
    <ul id="messages"></ul>
    <form id="form" action="">
        <input id="input" autocomplete="off" /><button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏–∫–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const nicknameArea = document.getElementById('nickname-area');
        const nicknameInput = document.getElementById('nickname');
        const setNicknameButton = document.getElementById('set-nickname');
        // üí° –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –ü–û–õ–Ø –ü–ê–†–û–õ–Ø
        const passwordInput = document.getElementById('password'); 
        let username = '–ê–Ω–æ–Ω–∏–º'; 

        // -------------------------------------------------------------------
        // –§–£–ù–ö–¶–ò–Ø: –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function displayMessage(msg) {
            const item = document.createElement('li');
            
            if (msg.username === username) {
                item.classList.add('my-message');
            }
            
            if (msg.username === '–°–∏—Å—Ç–µ–º–∞') {
                item.innerHTML = `<em>${msg.text}</em>`;
                item.style.fontWeight = 'bold';
                item.style.width = '100%';
                item.style.float = 'none';
                item.style.background = 'none';
                item.style.textAlign = 'center';
            } else {
                item.textContent = `${msg.username}: ${msg.text}`;
            }
            
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }
        // -------------------------------------------------------------------

        // 1. üí° –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–í–û–î–ê –ò–ú–ï–ù–ò –ò –ü–ê–†–û–õ–Ø
        setNicknameButton.addEventListener('click', function() {
            const nicknameValue = nicknameInput.value.trim();
            const passwordValue = passwordInput.value;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–∞ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
            if (nicknameValue && passwordValue) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ò–ú–Ø –∏ –ü–ê–†–û–õ–¨ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                socket.emit('login', { username: nicknameValue, password: passwordValue }); 
            }
        });

        // üí° –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö: –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫—É –≤—Ö–æ–¥–∞
        socket.on('login response', function(response) {
            if (response.success) {
                username = response.username; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                
                // –°–∫—Ä—ã—Ç—å –æ–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç
                nicknameArea.style.display = 'none';
                messages.style.display = 'block';
                form.style.display = 'flex'; 
                
                if (input) {
                    input.placeholder = `–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ ${username}...`;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å–æ–±—ã—Ç–∏–µ 'new user' —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–∏—Ç—å –≤—Å–µ—Ö –æ –≤—Ö–æ–¥–µ
                // –í–ê–ñ–ù–û: –ú—ã –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–º–µ–Ω–∏, —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è!
                socket.emit('new user'); 

            } else {
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + response.message);
                passwordInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
            }
        });
        
        // 2. –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø (–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º)
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                const msgText = input.value;
                
                socket.emit('chat message', msgText); 
                
                displayMessage({ 
                    username: username,
                    text: msgText 
                });
                
                input.value = '';
            }
        });

        // 3. –û–ë–†–ê–ë–û–¢–ö–ê –ò–°–¢–û–†–ò–ò (–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º)
        socket.on('history', function(msgs) {
            msgs.forEach(displayMessage);
        });

        // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ù–û–í–û–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º)
        socket.on('chat message', function(msg) {
            displayMessage(msg); 
        });

    </script>
</body>
</html>